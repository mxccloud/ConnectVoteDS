<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectVote - Voter Data Capture</title>
    <meta name="description" content="Secure voter data capture application with Supabase integration">
    <meta name="theme-color" content="#007749">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --anc-black: #000000;
            --anc-green: #007749;
            --anc-gold: #FFB612;
            --anc-light: #F5F5F5;
            --anc-dark: #333333;
            --anc-gray: #666666;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            padding: 0 15px;
            margin: 0 auto;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 720px;
            }
        }
        
        @media (min-width: 992px) {
            .container {
                max-width: 960px;
            }
        }
        
        header {
            background: linear-gradient(135deg, var(--anc-black), var(--anc-green));
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .logo i {
            font-size: 1.5rem;
            color: var(--anc-gold);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-container {
            background-color: rgba(255, 255, 255, 0.3);
            height: 6px;
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--anc-gold);
            width: 11%;
            transition: width 0.3s ease;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .step {
            text-align: center;
            flex: 1;
        }
        
        .step.active {
            color: var(--anc-gold);
            font-weight: bold;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--anc-green);
        }
        
        h2 {
            color: var(--anc-green);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--anc-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: var(--anc-gold);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--anc-dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--anc-green);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 119, 73, 0.2);
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
        }
        
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        input[type="radio"],
        input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: translateY(1px);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--anc-green);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #00603a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background-color: var(--anc-black);
        }
        
        .btn-secondary:hover {
            background-color: #333;
        }
        
        .btn-gold {
            background-color: var(--anc-gold);
            color: var(--anc-black);
        }
        
        .btn-gold:hover {
            background-color: #e6a50f;
        }
        
        .btn-logout {
            background-color: #e74c3c;
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--anc-gold);
        }
        
        .summary-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: bold;
            color: var(--anc-green);
            margin-bottom: 5px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: var(--anc-gray);
            font-size: 0.9rem;
            background-color: var(--anc-light);
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--anc-green);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--anc-black), var(--anc-green));
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo i {
            font-size: 3rem;
            color: var(--anc-green);
        }
        
        .login-logo h1 {
            color: var(--anc-green);
            margin-top: 10px;
        }
        
        .admin-info {
            background-color: #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #fdcb6e;
            font-size: 14px;
        }
        
        .supabase-info {
            background-color: #3ecf8e;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #277a56;
            font-size: 14px;
            text-align: center;
        }
        
        .config-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--anc-gold);
        }
        
        .anc-header-stripe {
            height: 8px;
            background: linear-gradient(to right, var(--anc-black) 0%, var(--anc-black) 33%, var(--anc-green) 33%, var(--anc-green) 66%, var(--anc-gold) 66%, var(--anc-gold) 100%);
        }
        
        .supabase-status {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background: #3ecf8e;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-vote-yea"></i>
                <h1>ConnectVote</h1>
                <p>Secure Voter Data Capture</p>
            </div>
            
            <div class="supabase-info">
                <p><strong>Supabase Powered</strong> - Real-time database with secure authentication</p>
            </div>
            
            <div class="admin-info">
                <p><strong>Administrator Note:</strong> User accounts must be created through the admin portal. Contact your system administrator for login credentials.</p>
            </div>
            
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Enter your email">
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            
            <button class="btn" id="loginBtn" style="width: 100%">Login</button>
            
            <div style="text-align: center; margin-top: 20px;">
                <p>Demo Credentials:<br>
                <small>Email: <strong>field_agent1@example.com</strong> | Password: <strong>Pass123!</strong></small></p>
            </div>
        </div>
    </div>

    <!-- Main Application (initially hidden) -->
    <div id="appContainer" style="display: none;">
        <div class="supabase-status" id="supabaseStatus">
            <i class="fas fa-database"></i> <span id="supabaseStatusText"></span>
        </div>
        
        <div class="anc-header-stripe"></div>
        
        <header>
            <div class="app-bar">
                <div class="logo">
                    <i class="fas fa-vote-yea"></i>
                    <span>ConnectVote</span>
                </div>
                <div class="user-info">
                    <span id="currentUserName">User</span>
                    <button class="btn btn-logout" id="logoutBtn">Logout</button>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="step-indicator">
                <div class="step active" data-step="1">Verification</div>
                <div class="step" data-step="2">Demographics</div>
                <div class="step" data-step="3">Education</div>
                <div class="step" data-step="4">Employment</div>
                <div class="step" data-step="5">Social</div>
                <div class="step" data-step="6">Community</div>
                <div class="step" data-step="7">Political</div>
                <div class="step" data-step="8">Communication</div>
                <div class="step" data-step="9">Aspirations</div>
            </div>
        </header>
        
        <div class="container">
            <!-- Supabase Configuration Panel (for demo purposes) -->
            <div class="config-panel">
                <h2><i class="fas fa-database"></i> Supabase Connection</h2>
                <p>This app is connected to a real Supabase backend. All data is stored securely in PostgreSQL.</p>
                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL</label>
                    <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" value="https://oyrzshsgnlyzlmtbwgli.supabase.co">
                </div>
                <div class="form-group">
                    <label for="supabaseKey">Supabase API Key</label>
                    <input type="text" id="supabaseKey" placeholder="your-anon-key" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cnpzaHNnbmx5emxtdGJ3Z2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDc1OTUsImV4cCI6MjA3MTg4MzU5NX0.PUMQxVsSik2RnsjOWxEEpQEMu7Bu2RZ6-kwHkUUKw6I">
                </div>
                <button class="btn" id="testSupabaseConnection">Test Connection</button>
            </div>

            <!-- Step 1: Verification -->
            <div class="step-content active" id="step1">
                <div class="card">
                    <h2><i class="fas fa-id-card"></i> Voter Verification</h2>
                    <div class="form-group">
                        <label for="idNumber">ID Number</label>
                        <input type="text" id="idNumber" placeholder="Enter your South African ID number">
                    </div>
                    <button class="btn" id="verifyBtn">Verify with IEC</button>
                </div>
                
                <div class="card" id="verificationResults" style="display: none;">
                    <h2>Verification Results</h2>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" readonly>
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="text" id="age" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ward</label>
                        <input type="text" id="ward" readonly>
                    </div>
                    <div class="form-group">
                        <label>Voting District</label>
                        <input type="text" id="votingDistrict" readonly>
                    </div>
                    <div class="form-group">
                        <label>Current Voting Station</label>
                        <input type="text" id="votingStation" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Do you want to change your voting station?</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="changeStation" value="yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="changeStation" value="no" checked> No
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="navigation">
                    <div></div>
                    <button class="btn btn-gold" id="toStep2">Continue</button>
                </div>
            </div>
            
            <!-- Steps 2-8 would follow the same pattern -->
            
            <!-- Step 9: Personal Aspirations -->
            <div class="step-content" id="step9">
                <div class="card">
                    <h2><i class="fas fa-star"></i> Personal Aspirations</h2>
                    
                    <div class="form-group">
                        <label>What is your number one personal priority right now?</label>
                        <select id="priority">
                            <option value="">Select your priority</option>
                            <option value="job">Job</option>
                            <option value="education">Education</option>
                            <option value="business">Business support</option>
                            <option value="housing">Housing</option>
                            <option value="safety">Safety</option>
                            <option value="health">Health</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Would you like to receive notifications about opportunities?</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="notifications" value="yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="notifications" value="no"> No
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Review & Submit button is correctly placed at the end of Step 9 -->
                <div class="navigation">
                    <button class="btn btn-secondary" id="toStep8">Back</button>
                    <button class="btn btn-gold" id="toSummary">Review & Submit</button>
                </div>
            </div>
            
            <!-- Summary Step -->
            <div class="step-content" id="summary">
                <div class="card">
                    <h2><i class="fas fa-check-circle"></i> Review Your Information</h2>
                    <p>Please review all your information before submitting.</p>
                    
                    <div class="summary-card">
                        <h3>Verification Details</h3>
                        <div class="summary-item">
                            <div class="summary-label">ID Number</div>
                            <div id="summary-id"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Full Name</div>
                            <div id="summary-name"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Voting Station</div>
                            <div id="summary-station"></div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h3>Demographics</h3>
                        <div class="summary-item">
                            <div class="summary-label">Gender & Marital Status</div>
                            <div id="summary-demographics"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Household Size & Housing</div>
                            <div id="summary-household"></div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h3>Personal Priorities</h3>
                        <div class="summary-item">
                            <div class="summary-label">Main Priority</div>
                            <div id="summary-priority"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-option">
                            <input type="checkbox" id="consentCheck">
                            I confirm that the information provided is accurate and consent to its use for improving service delivery.
                        </label>
                    </div>
                    
                    <button class="btn btn-gold" id="submitBtn" disabled>Submit to Supabase</button>
                </div>
            </div>
            
            <!-- Confirmation Screen -->
            <div class="step-content" id="confirmation">
                <div class="card" style="text-align: center;">
                    <div style="font-size: 4rem; color: var(--anc-green);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2>Thank You!</h2>
                    <p>Your voter profile has been successfully submitted to our secure database.</p>
                    <p>Your information will help us better understand community needs and improve service delivery.</p>
                    
                    <div style="margin: 30px 0;">
                        <button class="btn" id="downloadProfile">
                            <i class="fas fa-download"></i> Download Profile
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" id="newEntry">
                        <i class="fas fa-plus"></i> Start New Entry
                    </button>
                </div>
            </div>
        </div>
        
        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i> <span id="notificationText"></span>
        </div>
        
        <footer>
            <p>ConnectVote &copy; 2025 | Powered by Supabase</p>
            <p>This information is collected for improving service delivery and community engagement</p>
        </footer>
    </div>

    <script>
        // Initialize Supabase with your provided credentials
        const SUPABASE_URL = 'https://oyrzshsgnlyzlmtbwgli.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95cnpzaHNnbmx5emxtdGJ3Z2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMDc1OTUsImV4cCI6MjA3MTg4MzU5NX0.PUMQxVsSik2RnsjOWxEEpQEMu7Bu2RZ6-kwHkUUKw6I';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Current step tracking
        let currentStep = 1;
        const totalSteps = 9;
        let currentUser = null;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const progressBar = document.getElementById('progressBar');
        const stepElements = document.querySelectorAll('.step');
        const stepContents = document.querySelectorAll('.step-content');
        const currentUserName = document.getElementById('currentUserName');
        const supabaseStatus = document.getElementById('supabaseStatus');
        const supabaseStatusText = document.getElementById('supabaseStatusText');
        
        // Initialize the app
        function initApp() {
            // Check if user is already logged in (from localStorage)
            const savedUser = localStorage.getItem('supabaseUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showApp();
                    checkSupabaseConnection();
                } catch (e) {
                    console.error("Error parsing saved user data", e);
                    localStorage.removeItem('supabaseUser');
                }
            }
            
            setupEventListeners();
        }
        
        // Show the main application
        function showApp() {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'block';
            currentUserName.textContent = currentUser.email;
            updateProgress();
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Show Supabase status
        function showSupabaseStatus(message, isSuccess = true) {
            supabaseStatusText.textContent = message;
            supabaseStatus.style.background = isSuccess ? '#3ecf8e' : '#e74c3c';
            supabaseStatus.style.display = 'block';
            
            setTimeout(() => {
                supabaseStatus.style.display = 'none';
            }, 5000);
        }
        
        // Check Supabase connection
        async function checkSupabaseConnection() {
            try {
                const { data, error } = await supabase.from('voter_profiles').select('count').limit(1);
                
                if (error) {
                    showSupabaseStatus("Supabase connection failed", false);
                    console.error('Supabase error:', error);
                } else {
                    showSupabaseStatus("Connected to Supabase successfully", true);
                }
            } catch (error) {
                showSupabaseStatus("Supabase connection error", false);
                console.error('Connection error:', error);
            }
        }
        
        // Update progress bar and step indicators
        function updateProgress() {
            // Update progress bar width
            const progressPercentage = (currentStep / totalSteps) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            
            // Update step indicators
            stepElements.forEach((step, index) => {
                if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Show current step content
            stepContents.forEach((content, index) => {
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            window.scrollTo(0, 0);
        }
        
        // Navigate to a specific step
        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= totalSteps + 2) {
                currentStep = stepNumber;
                updateProgress();
            }
        }
        
        // Handle login with Supabase
        async function handleLogin(email, password) {
            if (!email || !password) {
                showNotification('Please enter both email and password');
                return false;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) {
                    showNotification('Login error: ' + error.message);
                    return false;
                }
                
                currentUser = data.user;
                localStorage.setItem('supabaseUser', JSON.stringify(currentUser));
                
                showApp();
                showNotification(`Welcome back, ${currentUser.email}!`);
                checkSupabaseConnection();
                return true;
            } catch (error) {
                showNotification('Login failed: ' + error.message);
                return false;
            }
        }
        
        // Handle logout
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                localStorage.removeItem('supabaseUser');
                appContainer.style.display = 'none';
                loginScreen.style.display = 'flex';
                
                // Clear form fields
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                
                showNotification('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Save data to Supabase
        async function saveDataToSupabase(formData) {
            try {
                showSupabaseStatus("Saving data to Supabase...");
                
                const { data, error } = await supabase
                    .from('voter_profiles')
                    .insert([formData])
                    .select();
                
                if (error) {
                    showSupabaseStatus("Error saving to Supabase", false);
                    throw error;
                }
                
                showSupabaseStatus("Data saved to Supabase successfully", true);
                return data;
            } catch (error) {
                console.error('Supabase error:', error);
                throw error;
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Login button
            document.getElementById('loginBtn').addEventListener('click', async () => {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                await handleLogin(email, password);
            });
            
            // Allow Enter key to submit login form
            document.getElementById('password').addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    await handleLogin(email, password);
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Test Supabase connection
            document.getElementById('testSupabaseConnection').addEventListener('click', checkSupabaseConnection);
            
            // Navigation buttons
            document.getElementById('toStep2').addEventListener('click', () => goToStep(2));
            document.getElementById('toStep1').addEventListener('click', () => goToStep(1));
            document.getElementById('toStep3').addEventListener('click', () => goToStep(3));
            document.getElementById('toStep2Back').addEventListener('click', () => goToStep(2));
            document.getElementById('toStep4').addEventListener('click', () => goToStep(4));
            document.getElementById('toStep8').addEventListener('click', () => goToStep(8));
            document.getElementById('toSummary').addEventListener('click', () => {
                goToStep(10); // Summary is step 10
                updateSummary();
            });
            
            // Verify ID button
            document.getElementById('verifyBtn').addEventListener('click', () => {
                const idNumber = document.getElementById('idNumber').value;
                if (idNumber.length === 13 && !isNaN(idNumber)) {
                    // Simulate IEC verification
                    document.getElementById('verificationResults').style.display = 'block';
                    document.getElementById('fullName').value = 'Simulated Voter Name';
                    document.getElementById('age').value = 'Based on ID: ' + (2025 - parseInt(idNumber.substring(0, 2)) > 1900 ? 
                        2025 - (1900 + parseInt(idNumber.substring(0, 2))) : 
                        2025 - (2000 + parseInt(idNumber.substring(0, 2))));
                    document.getElementById('ward').value = 'Ward ' + (parseInt(idNumber.substring(7, 8)) + 1);
                    document.getElementById('votingDistrict').value = 'District ' + (parseInt(idNumber.substring(9, 10)) + 1);
                    document.getElementById('votingStation').value = 'Station ' + (parseInt(idNumber.substring(10, 12)) + 1);
                    
                    showNotification('ID successfully verified with IEC');
                } else {
                    showNotification('Please enter a valid 13-digit ID number');
                }
            });
            
            // Consent checkbox
            document.getElementById('consentCheck').addEventListener('change', function() {
                document.getElementById('submitBtn').disabled = !this.checked;
            });
            
            // Submit button - Now saves to Supabase
            document.getElementById('submitBtn').addEventListener('click', async () => {
                // Show confirmation screen
                goToStep(11); // Confirmation is step 11
                
                // Save data to Supabase
                try {
                    const formData = collectFormData();
                    const result = await saveDataToSupabase(formData);
                    
                    if (result) {
                        showNotification('Data successfully saved to database');
                    }
                } catch (error) {
                    showNotification('Error saving to database: ' + error.message);
                    console.error('Database Error:', error);
                }
            });
            
            // Download profile button
            document.getElementById('downloadProfile').addEventListener('click', () => {
                showNotification('Profile download started');
                // In a real app, this would generate a PDF
            });
            
            // New entry button
            document.getElementById('newEntry').addEventListener('click', () => {
                // Reset the form
                currentStep = 1;
                document.querySelectorAll('input, select').forEach(element => {
                    if (element.type !== 'button') {
                        element.value = '';
                        if (element.type === 'radio' || element.type === 'checkbox') {
                            element.checked = false;
                        }
                    }
                });
                // Reset first radio buttons
                document.querySelector('input[name="changeStation"]').checked = true;
                document.getElementById('verificationResults').style.display = 'none';
                
                updateProgress();
            });
        }
        
        // Collect all form data
        function collectFormData() {
            return {
                id_number: document.getElementById('idNumber').value,
                full_name: document.getElementById('fullName').value,
                age: document.getElementById('age').value,
                ward: document.getElementById('ward').value,
                voting_district: document.getElementById('votingDistrict').value,
                voting_station: document.getElementById('votingStation').value,
                change_station: document.querySelector('input[name="changeStation"]:checked').value,
                gender: document.querySelector('input[name="gender"]:checked')?.value,
                marital_status: document.getElementById('maritalStatus').value,
                household_size: document.getElementById('householdSize').value,
                housing_type: document.getElementById('housingType').value,
                priority: document.getElementById('priority').value,
                wants_notifications: document.querySelector('input[name="notifications"]:checked')?.value === 'yes',
                collected_by: currentUser.email,
                collected_at: new Date().toISOString()
            };
        }
        
        // Update summary with entered data
        function updateSummary() {
            document.getElementById('summary-id').textContent = document.getElementById('idNumber').value;
            document.getElementById('summary-name').textContent = document.getElementById('fullName').value;
            document.getElementById('summary-station').textContent = document.getElementById('votingStation').value;
            
            const gender = document.querySelector('input[name="gender"]:checked');
            const maritalStatus = document.getElementById('maritalStatus').value;
            document.getElementById('summary-demographics').textContent = 
                `${gender ? gender.value : 'Not specified'}, ${maritalStatus || 'Not specified'}`;
            
            const householdSize = document.getElementById('householdSize').value;
            const housingType = document.getElementById('housingType').value;
            document.getElementById('summary-household').textContent = 
                `${householdSize} people, ${housingType || 'Not specified'}`;
            
            const priority = document.getElementById('priority').value;
            document.getElementById('summary-priority').textContent = priority || 'Not specified';
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>